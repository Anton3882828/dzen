<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Физика Онлайн</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --warning: #f72585;
      --gray: #6c757d;
      --white: #ffffff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    .hidden { 
      display: none !important; 
    }

    .content-wrapper {
      flex: 1;
      padding: 20px;
      padding-bottom: 80px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .box {
      background: var(--white);
      padding: 25px;
      margin-bottom: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .box:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
    }

    .am {
      margin: 12px 0;
      padding: 16px;
      background: var(--white);
      border-radius: 12px;
      cursor: pointer;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .am:hover {
      background: rgba(67, 97, 238, 0.05);
      border-left: 4px solid var(--secondary);
      transform: translateX(5px);
    }

    input, button, textarea, select {
      margin: 10px 0;
      padding: 14px 20px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 50px;
      border: 1px solid #e0e3e9;
      font-family: 'Roboto', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .lesson-img {
      max-width: 100%;
      margin-top: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .action-button {
      border: 2px solid var(--primary);
      background-color: var(--primary);
      color: white;
      border-radius: 50px;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 14px 24px;
      margin: 8px 0;
      display: inline-block;
      width: auto;
    }
    
    .action-button:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .action-button.outline {
      background-color: transparent;
      color: var(--primary);
    }

    .action-button.outline:hover {
      background-color: rgba(67, 97, 238, 0.1);
    }

    .action-button.warning {
      background-color: var(--warning);
      border-color: var(--warning);
    }

    .action-button.warning:hover {
      background-color: #d91a6d;
      border-color: #d91a6d;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background: var(--white);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      z-index: 1000;
      padding: 0 10px;
    }

    .nav-btn {
      text-align: center;
      font-size: 12px;
      color: var(--gray);
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .nav-btn.active {
      color: var(--primary);
    }

    .nav-btn i {
      font-size: 20px;
      margin-bottom: 4px;
      color: var(--gray);
      transition: all 0.3s ease;
    }

    .nav-btn.active i {
      color: var(--primary);
    }

    .nav-btn:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .nav-btn:hover i {
      color: var(--primary);
    }

    .form-input {
      width: 100%;
      padding: 14px 20px;
      margin: 10px 0;
      border: 1px solid #e0e3e9;
      border-radius: 50px;
      font-size: 15px;
      transition: all 0.3s ease;
      background-color: var(--light);
    }

    .form-input:focus {
      border-color: var(--primary);
      background-color: var(--white);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      outline: none;
    }

    .search-input {
      border-color: var(--primary);
      padding-left: 45px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 20px center;
      background-size: 16px;
    }

    .spoiler-btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 50px;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      margin: 10px 0;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
      display: inline-block;
    }

    .spoiler-btn:hover {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
    }

    .spoiler-content {
      display: none;
      margin-top: 15px;
      padding: 20px;
      background-color: var(--light);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--dark);
      border-left: 4px solid var(--success);
    }

    .spoiler-content.open {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 2.2em; 
      font-family: 'Montserrat', sans-serif; 
      font-weight: 700; 
      color: var(--dark); 
      margin-bottom: 20px;
      position: relative;
      padding-bottom: 10px;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
      border-radius: 2px;
    }

    .auth-container {
      max-width: 500px;
      margin: 40px auto;
      padding: 30px;
      background: var(--white);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .auth-title {
      text-align: center;
      margin-bottom: 30px;
      color: var(--dark);
    }

    .auth-logo {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--gray);
      font-size: 14px;
    }

    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e0e3e9;
      margin: 0 10px;
    }

    .book-card {
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .book-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .book-actions {
      display: flex;
      gap: 10px;
    }

    .premium-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      margin-right: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .user-details h3 {
      margin: 0;
      font-size: 18px;
      color: var(--dark);
    }

    .user-details p {
      margin: 5px 0 0;
      color: var(--gray);
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--light);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    @media (max-width: 768px) {
      .content-wrapper {
        padding: 15px;
        padding-bottom: 80px;
      }
      
      .section-title {
        font-size: 1.8em;
      }
      
      .box {
        padding: 20px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .auth-container {
        padding: 20px;
        margin: 20px auto;
      }
    }
  </style>
</head>

<body>
  <div class="bottom-nav" id="bottomNav">
    <a class="nav-btn" id="homeBtn">
      <i class="fas fa-home"></i>
      Главная
    </a>
    <a class="nav-btn" id="libraryBtn">
      <i class="fas fa-book"></i>
      Библиотека
    </a>
    <a class="nav-btn" id="accountBtn">
      <i class="fas fa-user"></i>
      Аккаунт
    </a>
    <a class="nav-btn" href="1.html">
      <i class="fas fa-lightbulb"></i>
      Идеи
    </a>
  </div>

  <div class="content-wrapper">
    <!-- Секция авторизации -->
    <div id="authSection" class="auth-container">
      <div class="auth-title">
        <div class="auth-logo">
          <i class="fas fa-atom"></i>
        </div>
        <h2>Физика Онлайн</h2>
        <p>Изучайте физику с удовольствием</p>
      </div>
      
      <input class="form-input" type="text" id="username" placeholder="Имя пользователя" />
      <input class="form-input" type="email" id="email" placeholder="Email" />
      <input class="form-input" type="password" id="password" placeholder="Пароль" />
      
      <button class="spoiler-btn" onclick="toggleSpoiler()">
        <i class="fas fa-crown" style="margin-right: 8px;"></i>Премиум доступ
      </button>
      
      <div class="spoiler-content" id="spoiler">
        <h4 style="margin-bottom: 10px;">Преимущества премиум аккаунта:</h4>
        <ul style="padding-left: 20px;">
          <li>Возможность создавать свои уроки</li>
          <li>Приоритетная поддержка</li>
        </ul>
        <p>Чтобы получить Премиум аккаунт напишите в WhatsApp</p>
        <a href="https://wa.me/77781287591?text=Здравствуйте,%20у%20меня%20вопрос" target="_blank" class="action-button outline">
  Написать в WhatsApp
</a>
        <p style="margin-top: 15px; font-size: 14px; color: var(--gray);">Стоимость: 500тг/месяц</p>
      </div>
      
      <div class="auth-buttons">
          <button class="action-button guest" onclick="loginAsGuest()">
    <i class="fas fa-user-secret" style="margin-right: 8px;"></i>Войти как ученик
  </button>
  <div class="divider">или</div>
        <button class="action-button outline" onclick="login()">
          <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Вход
        </button>
        
        
        
      </div>
    </div>

    <!-- Основная секция -->
    <div id="mainSection" class="hidden">
      <!-- Секция библиотеки -->
      <div id="librarySection">
        <h1 class="section-title">Dzen</h1>
        <input class="form-input search-input" type="text" id="searchInput" placeholder="Поиск по книгам и урокам" oninput="searchBooksAndLessons()" />
        <div id="bookList">
          <div class="box" style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
            <p>Загрузка материалов...</p>
          </div>
        </div>
      </div>
      
      <!-- Секция добавления -->
      <div id="addSection" class="box hidden">
        <h1 class="section-title">Добавить материал</h1>
        
        <div class="box" style="background: rgba(67, 97, 238, 0.05); border-left: 4px solid var(--primary);">
          <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-book" style="margin-right: 10px;"></i>Добавить тему
          </h3>
          <input class="form-input" type="text" id="newBookTitle" placeholder="Название темы (например: 'Законы Ньютона')" />
          <button class="action-button" onclick="addBook()">
            <i class="fas fa-plus" style="margin-right: 8px;"></i>Добавить тему
          </button>
        </div>
        
        <div class="box" style="margin-top: 20px; background: rgba(76, 201, 240, 0.05); border-left: 4px solid var(--success);">
          <h3 style="margin-bottom: 15px; color: var(--success);">
            <i class="fas fa-file-alt" style="margin-right: 10px;"></i>Добавить урок
          </h3>
          <select class="form-input" id="bookSelect">
            <option>Выберите тему для урока</option>
          </select>
          <input class="form-input" type="text" id="lessonTitle" placeholder="Название урока (например: 'Первый закон Ньютона')" />
          <textarea class="form-input" id="lessonContent" placeholder="Содержание урока (подробное объяснение темы)" rows="5"></textarea>
          <input class="form-input" type="text" id="lessonImageUrl" placeholder="Ссылка на изображение (необязательно)" />
          <button class="action-button" onclick="addLesson()">
            <i class="fas fa-save" style="margin-right: 8px;"></i>Сохранить урок
          </button>
        </div>
      </div>

      <!-- Секция аккаунта -->
      <div id="accountSection" class="box hidden">
        <h1 class="section-title">Мой профиль</h1>
        
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <h3 id="userName">Пользователь</h3>
            <p id="userEmail">email@example.com</p>
            <p id="userStatus" style="color: var(--primary); font-size: 13px;">
              <i class="fas fa-circle" style="font-size: 8px; vertical-align: middle; margin-right: 5px;"></i>
              Стандартный аккаунт
            </p>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="booksCount">0</div>
            <div class="stat-label">Темы</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lessonsCount">0</div>
            <div class="stat-label">Уроки</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="savedCount">0</div>
            <div class="stat-label">Сохранено</div>
          </div>
        </div>
        
        <button class="action-button" id="adminButton" style="display: none;">
          <i class="fas fa-cog" style="margin-right: 8px;"></i>Панель администратора
        </button>
        
        <button class="action-button warning" onclick="logout()">
          <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Выйти
        </button>
      </div>

      <!-- Моя библиотека -->
      <div id="myLibrarySection" class="box hidden">
        <h1 class="section-title">Моя библиотека</h1>
        <div id="myBookList">
          <div class="box" style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-book-open" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
            <p>Ваши сохранённые материалы появятся здесь</p>
            <button class="action-button outline" onclick="showSection('library')" style="margin-top: 15px;">
              <i class="fas fa-search" style="margin-right: 8px;"></i>Найти материалы
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Инициализация Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyAtTcNlz445cBFFymIiAuDGT-Ylr_e5ewQ",
  authDomain: "fizika-8727d.firebaseapp.com",
  projectId: "fizika-8727d",
  storageBucket: "fizika-8727d.firebasestorage.app",
  messagingSenderId: "39044212427",
  appId: "1:39044212427:web:92a85cc7365c88b47d9d4e",
  measurementId: "G-ZQGW1X15V1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM элементы
    const elements = {
      authSection: document.getElementById("authSection"),
      mainSection: document.getElementById("mainSection"),
      userStatus: document.getElementById("userStatus"),
      bookList: document.getElementById("bookList"),
      bookSelect: document.getElementById("bookSelect"),
      myBookList: document.getElementById("myBookList"),
      librarySection: document.getElementById("librarySection"),
      addSection: document.getElementById("addSection"),
      accountSection: document.getElementById("accountSection"),
      myLibrarySection: document.getElementById("myLibrarySection"),
      bottomNav: document.getElementById("bottomNav"),
      adminButton: document.getElementById("adminButton"),
      spoiler: document.getElementById("spoiler"),
      homeBtn: document.getElementById("homeBtn"),
      libraryBtn: document.getElementById("libraryBtn"),
      accountBtn: document.getElementById("accountBtn"),
      userAvatar: document.getElementById("userAvatar"),
      userName: document.getElementById("userName"),
      userEmail: document.getElementById("userEmail"),
      booksCount: document.getElementById("booksCount"),
      lessonsCount: document.getElementById("lessonsCount"),
      savedCount: document.getElementById("savedCount")
    };

    let allBooks = []; // Массив для хранения всех книг и уроков для поиска
    let userStats = { books: 0, lessons: 0, saved: 0 };

    // Общие функции
    function toggleSpoiler() {
      elements.spoiler.classList.toggle("open");
    }

    function redirectToAdmin() {
      window.location.href = "admin.html";
    }

    function activateNavButton(btn) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function showSection(section) {
      const sections = ['library', 'add', 'account', 'myLibrary'];
      sections.forEach(sec => {
        elements[`${sec}Section`].classList.add("hidden");
      });
      
      if (section === "library") {
        elements.librarySection.classList.remove("hidden");
        activateNavButton(elements.homeBtn);
        loadBooks();
      }
      else if (section === "add") {
        elements.addSection.classList.remove("hidden");
        loadBookOptions();
      }
      else if (section === "account") {
        elements.accountSection.classList.remove("hidden");
        activateNavButton(elements.accountBtn);
        updateUserProfile();
      }
      else if (section === "myLibrary") {
        elements.myLibrarySection.classList.remove("hidden");
        activateNavButton(elements.libraryBtn);
        loadMyLibrary();
      }
    }

    // Навигационные кнопки
    elements.homeBtn.onclick = () => showSection('library');
    elements.libraryBtn.onclick = () => showSection('myLibrary');
    elements.accountBtn.onclick = () => showSection('account');
    elements.adminButton.onclick = redirectToAdmin;

    // Функции аутентификации
    function register() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      const username = document.getElementById("username").value;
      
      if (!username) return showAlert("Введите имя пользователя", "warning");
      if (!email) return showAlert("Введите email", "warning");
      if (!pass) return showAlert("Введите пароль", "warning");

      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred => {
          return db.collection("users").doc(cred.user.uid).set({ 
            username,
            email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => showAlert("Регистрация прошла успешно!", "success"))
        .catch(err => showAlert("Ошибка: " + err.message, "error"));
    }

    function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      
      if (!email) return showAlert("Введите email", "warning");
      if (!pass) return showAlert("Введите пароль", "warning");

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => showAlert("Вход выполнен", "success"))
        .catch(err => showAlert("Ошибка: " + err.message, "error"));
    }

    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          const userRef = db.collection("users").doc(user.uid);
          
          return userRef.get().then(doc => {
            if (!doc.exists) {
              return userRef.set({ 
                username: user.displayName || "Пользователь",
                email: user.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          });
        })
        .then(() => showAlert("Вход выполнен через Google", "success"))
        .catch(error => {
          console.error("Ошибка входа через Google:", error);
          showAlert("Ошибка входа: " + error.message, "error");
        });
    }

    function logout() {
      auth.signOut()
        .then(() => showAlert("Вы вышли из аккаунта", "info"));
    }

    function showAlert(message, type = "info") {
      // Можно реализовать красивые уведомления
      alert(message);
    }

    // Функции работы с книгами
    async function loadBooks() {
      elements.bookList.innerHTML = `
        <div class="box" style="text-align: center; padding: 40px 20px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
          <p>Загрузка материалов...</p>
        </div>
      `;
      
      allBooks = [];
      userStats.books = 0;
      userStats.lessons = 0;

      try {
        const snapshot = await db.collection("books").get();
        
<!-- В функции loadBooks замените этот блок -->
if (snapshot.empty) {
  elements.bookList.innerHTML = `
    <div class="box" style="text-align: center; padding: 40px 20px;">
      <i class="fas fa-book" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
      <p>Пока нет ни одной темы</p>
    </div>
  `;
  return;
}
        
        elements.bookList.innerHTML = "";
        
        for (const doc of snapshot.docs) {
          const book = doc.data();
          userStats.books++;
          
          const bookDiv = document.createElement("div");
          bookDiv.className = "box book-card";
          
          const bookHeader = document.createElement("div");
          bookHeader.className = "book-header";
          
          const bookTitle = document.createElement("h3");
          bookTitle.textContent = book.title;
          bookTitle.style.margin = "0";
          
          const bookActions = document.createElement("div");
          bookActions.className = "book-actions";
          
          const addBtn = document.createElement("button");
          addBtn.className = "action-button outline";
          addBtn.style.padding = "8px 12px";
          addBtn.style.fontSize = "12px";
          addBtn.innerHTML = '<i class="fas fa-plus" style="margin-right: 5px;"></i>Добавить';
          addBtn.onclick = (e) => {
            e.stopPropagation();
            addLessonToMyLibrary(doc.id, book.title, "");
          };
          
          bookActions.appendChild(addBtn);
          bookHeader.appendChild(bookTitle);
          bookHeader.appendChild(bookActions);
          bookDiv.appendChild(bookHeader);
          
          const lessonsSnapshot = await db.collection("books").doc(doc.id).collection("lessons").get();
          const lessons = [];
          
          if (lessonsSnapshot.empty) {
            const emptyMsg = document.createElement("p");
            emptyMsg.textContent = "Пока нет уроков по этой теме";
            emptyMsg.style.color = "var(--gray)";
            emptyMsg.style.fontStyle = "italic";
            bookDiv.appendChild(emptyMsg);
          } else {
            for (const lessonDoc of lessonsSnapshot.docs) {
              const lesson = lessonDoc.data();
              userStats.lessons++;
              
              const lessonDiv = createLessonElement(lesson, doc.id);
              lessons.push(lesson);
              bookDiv.appendChild(lessonDiv);
            }
          }
          
          allBooks.push({ book: { ...book, id: doc.id }, lessons });
          elements.bookList.appendChild(bookDiv);
        }
        
        updateStats();
      } catch (error) {
        console.error("Ошибка загрузки книг:", error);
        elements.bookList.innerHTML = `
          <div class="box" style="text-align: center; padding: 40px 20px; color: var(--warning);">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 15px;"></i>
            <p>Произошла ошибка при загрузке материалов</p>
            <button class="action-button outline" onclick="loadBooks()" style="margin-top: 15px;">
              <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Попробовать снова
            </button>
          </div>
        `;
      }
    }

    function createLessonElement(lesson, bookId) {
      const lessonDiv = document.createElement("div");
      lessonDiv.className = "am";
      
      const lessonTitle = document.createElement("div");
      lessonTitle.textContent = lesson.title;
      lessonTitle.style.flex = "1";
      
      const addBtn = document.createElement("button");
      addBtn.className = "action-button outline";
      addBtn.style.padding = "8px 12px";
      addBtn.style.fontSize = "12px";
      addBtn.innerHTML = '<i class="fas fa-bookmark" style="margin-right: 5px;"></i>Сохранить';
      addBtn.onclick = e => {
        e.stopPropagation();
        addLessonToMyLibrary(bookId, lesson.title, lesson.content);
      };
      
      lessonDiv.appendChild(lessonTitle);
      lessonDiv.appendChild(addBtn);
      lessonDiv.onclick = () => openLesson(lesson);
      
      return lessonDiv;
    }

    function openLesson(lesson) {
      const url = `lesson.html?title=${encodeURIComponent(lesson.title)}&content=${encodeURIComponent(lesson.content)}&image=${encodeURIComponent(lesson.imageUrl || "")}`;
      window.open(url, "_blank");
    }

    async function loadMyLibrary() {
      const user = auth.currentUser;
      if (!user) return;
      
      elements.myBookList.innerHTML = `
        <div class="box" style="text-align: center; padding: 40px 20px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
          <p>Загрузка вашей библиотеки...</p>
        </div>
      `;
      
      userStats.saved = 0;

      try {
        const userBooks = await db.collection("users").doc(user.uid).collection("myBooks").get();
        
        if (userBooks.empty) {
          elements.myBookList.innerHTML = `
            <div class="box" style="text-align: center; padding: 40px 20px;">
              <i class="fas fa-book-open" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
              <p>Ваша библиотека пуста</p>
              <button class="action-button" onclick="showSection('library')" style="margin-top: 15px;">
                <i class="fas fa-search" style="margin-right: 8px;"></i>Найти материалы
              </button>
            </div>
          `;
          return;
        }
        
        elements.myBookList.innerHTML = "";
        
        for (const doc of userBooks.docs) {
          const book = doc.data();
          userStats.saved++;
          
          const bookDiv = document.createElement("div");
          bookDiv.className = "box book-card";
          
          const bookHeader = document.createElement("div");
          bookHeader.className = "book-header";
          
          const bookTitle = document.createElement("h3");
          bookTitle.textContent = book.title;
          bookTitle.style.margin = "0";
          
          const bookActions = document.createElement("div");
          bookActions.className = "book-actions";
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "action-button warning";
          removeBtn.style.padding = "8px 12px";
          removeBtn.style.fontSize = "12px";
          removeBtn.innerHTML = '<i class="fas fa-trash" style="margin-right: 5px;"></i>Удалить';
          removeBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm("Вы уверены, что хотите удалить этот материал из библиотеки?")) {
              await db.collection("users").doc(user.uid).collection("myBooks").doc(doc.id).delete();
              showAlert("Материал удалён из библиотеки", "info");
              loadMyLibrary();
            }
          };
          
          bookActions.appendChild(removeBtn);
          bookHeader.appendChild(bookTitle);
          bookHeader.appendChild(bookActions);
          bookDiv.appendChild(bookHeader);
          
          try {
            const lessons = await db.collection("books").doc(book.bookId).collection("lessons").get();
            
            if (lessons.empty) {
              const emptyMsg = document.createElement("p");
              emptyMsg.textContent = "Нет доступных уроков";
              emptyMsg.style.color = "var(--gray)";
              emptyMsg.style.fontStyle = "italic";
              bookDiv.appendChild(emptyMsg);
            } else {
              for (const lessonDoc of lessons.docs) {
                const lesson = lessonDoc.data();
                const lessonDiv = document.createElement("div");
                lessonDiv.className = "am";
                lessonDiv.textContent = lesson.title;
                lessonDiv.onclick = () => openLesson(lesson);
                bookDiv.appendChild(lessonDiv);
              }
            }
          } catch (error) {
            console.error("Ошибка загрузки уроков:", error);
            const errorMsg = document.createElement("p");
            errorMsg.textContent = "Ошибка загрузки уроков";
            errorMsg.style.color = "var(--warning)";
            bookDiv.appendChild(errorMsg);
          }
          
          elements.myBookList.appendChild(bookDiv);
        }
        
        updateStats();
      } catch (error) {
        console.error("Ошибка загрузки библиотеки:", error);
        elements.myBookList.innerHTML = `
          <div class="box" style="text-align: center; padding: 40px 20px; color: var(--warning);">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 15px;"></i>
            <p>Произошла ошибка при загрузке вашей библиотеки</p>
            <button class="action-button outline" onclick="loadMyLibrary()" style="margin-top: 15px;">
              <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Попробовать снова
            </button>
          </div>
        `;
      }
    }

    async function loadBookOptions() {
      try {
        const snapshot = await db.collection("books").get();
        elements.bookSelect.innerHTML = "";
        
        if (snapshot.empty) {
          elements.bookSelect.innerHTML = '<option>Нет доступных тем</option>';
          return;
        }
        
        snapshot.forEach(doc => {
          const book = doc.data();
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = book.title;
          elements.bookSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Ошибка загрузки списка тем:", error);
        elements.bookSelect.innerHTML = '<option>Ошибка загрузки тем</option>';
      }
    }

    function addBook() {
      const title = document.getElementById("newBookTitle").value.trim();
      if (!title) return showAlert("Введите название темы", "warning");

      db.collection("books").add({ 
        title,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
        .then(() => {
          showAlert("Тема успешно добавлена", "success");
          document.getElementById("newBookTitle").value = "";
          loadBooks();
          loadBookOptions();
        })
        .catch(err => showAlert("Ошибка: " + err.message, "error"));
    }

    function addLesson() {
      const bookId = elements.bookSelect.value;
      const title = document.getElementById("lessonTitle").value.trim();
      const content = document.getElementById("lessonContent").value.trim();
      const imageUrl = document.getElementById("lessonImageUrl").value.trim();

      if (!bookId || bookId === "Выберите тему для урока") return showAlert("Выберите тему", "warning");
      if (!title) return showAlert("Введите название урока", "warning");
      if (!content) return showAlert("Введите содержание урока", "warning");

      db.collection("books").doc(bookId).collection("lessons").add({
        title,
        content,
        imageUrl: imageUrl || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        showAlert("Урок успешно добавлен", "success");
        document.getElementById("lessonTitle").value = "";
        document.getElementById("lessonContent").value = "";
        document.getElementById("lessonImageUrl").value = "";
        loadBooks();
      })
      .catch(err => showAlert("Ошибка: " + err.message, "error"));
    }

    function addLessonToMyLibrary(bookId, title, content) {
      const user = auth.currentUser;
      if (!user) return showAlert("Пожалуйста, войдите в систему", "warning");

      db.collection("users").doc(user.uid).collection("myBooks").add({
        title,
        bookId,
        addedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        showAlert("Материал добавлен в вашу библиотеку", "success");
        loadMyLibrary();
      }).catch(err => showAlert("Ошибка: " + err.message, "error"));
    }

    function searchBooksAndLessons() {
      const query = document.getElementById("searchInput").value.toLowerCase().trim();
      
      if (!query) {
        loadBooks();
        return;
      }
      
      const filteredBooks = allBooks.filter(item => {
        const bookTitle = item.book.title.toLowerCase();
        const lessonTitles = item.lessons.map(lesson => lesson.title.toLowerCase());
        const lessonContents = item.lessons.map(lesson => lesson.content.toLowerCase());
        
        return bookTitle.includes(query) || 
               lessonTitles.some(title => title.includes(query)) ||
               lessonContents.some(content => content.includes(query));
      });

      if (filteredBooks.length === 0) {
        elements.bookList.innerHTML = `
          <div class="box" style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-search" style="font-size: 24px; color: var(--primary); margin-bottom: 15px;"></i>
            <p>Ничего не найдено по запросу "${query}"</p>
            <button class="action-button outline" onclick="document.getElementById('searchInput').value = ''; loadBooks()" style="margin-top: 15px;">
              <i class="fas fa-times" style="margin-right: 8px;"></i>Очистить поиск
            </button>
          </div>
        `;
        return;
      }

      elements.bookList.innerHTML = "";
      filteredBooks.forEach(item => {
        const bookDiv = document.createElement("div");
        bookDiv.className = "box book-card";
        
        const bookHeader = document.createElement("div");
        bookHeader.className = "book-header";
        
        const bookTitle = document.createElement("h3");
        bookTitle.textContent = item.book.title;
        bookTitle.style.margin = "0";
        
        const bookActions = document.createElement("div");
        bookActions.className = "book-actions";
        
        const addBtn = document.createElement("button");
        addBtn.className = "action-button outline";
        addBtn.style.padding = "8px 12px";
        addBtn.style.fontSize = "12px";
        addBtn.innerHTML = '<i class="fas fa-bookmark" style="margin-right: 5px;"></i>Сохранить';
        addBtn.onclick = e => {
          e.stopPropagation();
          addLessonToMyLibrary(item.book.id, item.book.title, "");
        };
        
        bookActions.appendChild(addBtn);
        bookHeader.appendChild(bookTitle);
        bookHeader.appendChild(bookActions);
        bookDiv.appendChild(bookHeader);

        item.lessons.forEach(lesson => {
          const lessonDiv = createLessonElement(lesson, item.book.id);
          bookDiv.appendChild(lessonDiv);
        });

        elements.bookList.appendChild(bookDiv);
      });
    }

       function updateUserProfile() {
      const user = auth.currentUser;
      if (!user) return;
      

      db.collection("users").doc(user.uid).get().then(doc => {
        const userData = doc.data();
        const username = userData?.username || "Пользователь";
        

        elements.userName.textContent = username;
        elements.userAvatar.textContent = username.charAt(0).toUpperCase();
        elements.userEmail.textContent = user.email || "Email не указан";
        
    
        if (username && username.toLowerCase() === "админ") {
          elements.adminButton.style.display = "block";
        } else {
          elements.adminButton.style.display = "none";
        }
      }).catch(error => {
        console.error("Ошибка загрузки данных пользователя:", error);
        elements.userName.textContent = user.displayName || "Пользователь";
        elements.userAvatar.textContent = (user.displayName || "П").charAt(0).toUpperCase();
        elements.userEmail.textContent = user.email || "Email не указан";
        elements.adminButton.style.display = "none";
      });
      
    
      updateStats();
    }



    function updateStats() {
      elements.booksCount.textContent = userStats.books;
      elements.lessonsCount.textContent = userStats.lessons;
      elements.savedCount.textContent = userStats.saved;
    }

    // Обработчик состояния аутентификации
    auth.onAuthStateChanged(user => {
      if (user) {
        elements.authSection.classList.add("hidden");
        elements.mainSection.classList.remove("hidden");
        elements.bottomNav.style.display = "flex";
        showSection("library");
        updateUserProfile();
        
        // Загрузка данных
        loadBooks();
        loadMyLibrary();
        loadBookOptions();
      } else {
        elements.authSection.classList.remove("hidden");
        elements.mainSection.classList.add("hidden");
        elements.bottomNav.style.display = "none";
        
        // Сброс статистики
        userStats = { books: 0, lessons: 0, saved: 0 };
      }
    });
  </script>


<div id="accountSection" class="box hidden">
  <h1 class="section-title">Мой профиль</h1>
  <div id="guestAccountInfo" class="hidden">
    <div class="user-info">
      <div class="user-avatar">G</div>
      <div class="user-details">
        <h3>ученик </h3>
        <p>Для сохранения материалов требуется регистрация</p>
      </div>
    </div>
    <button class="action-button" onclick="showAuthSection()">
      <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Войти в аккаунт
    </button>
  </div>

  <div id="userAccountInfo">

  </div>
</div>


<script>

  function loginAsGuest() {
    auth.signInAnonymously()
      .then(() => {
        showAlert('Добро пожаловать, ученик!', 'success');
        updateUIForGuest();
      })
      .catch(error => {
        showAlert('Ошибка гостевого входа: ' + error.message, 'error');
      });
  }


  function updateUIForGuest() {
    elements.accountBtn.style.display = 'block';
    document.getElementById('userAccountInfo').classList.add('hidden');
    document.getElementById('guestAccountInfo').classList.remove('hidden');
    document.getElementById('addSection').classList.add('hidden');
  }


  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.isAnonymous) {
        updateUIForGuest();
      } else {

      }
    } else {

    }
  });





  
</script>
</body>
</html>












